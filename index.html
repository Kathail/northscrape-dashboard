<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NorthScrape Leads</title>

        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            slate: {
                                850: "#1e293b",
                                900: "#0f172a",
                                950: "#020617",
                            },
                        },
                    },
                },
            };
        </script>

        <style>
            /* Smooth transitions for theme switching */
            body,
            .bg-white,
            .bg-slate-50,
            .bg-slate-800,
            tr {
                transition:
                    background-color 0.2s ease,
                    color 0.2s ease;
            }

            /* Glass effect */
            .glass-panel {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(229, 231, 235, 0.5);
            }
            .dark .glass-panel {
                background: rgba(30, 41, 59, 0.95);
                border: 1px solid rgba(71, 85, 105, 0.5);
            }

            /* Custom Checkbox */
            .custom-checkbox {
                appearance: none;
                background-color: #fff;
                margin: 0;
                width: 1.25em;
                height: 1.25em;
                border: 2px solid #cbd5e1;
                border-radius: 0.25em;
                display: grid;
                place-content: center;
                cursor: pointer;
            }
            .dark .custom-checkbox {
                background-color: #1e293b;
                border-color: #475569;
            }
            .custom-checkbox::before {
                content: "";
                width: 0.65em;
                height: 0.65em;
                transform: scale(0);
                transition: 120ms;
                box-shadow: inset 1em 1em white;
                transform-origin: center;
                clip-path: polygon(
                    14% 44%,
                    0 65%,
                    50% 100%,
                    100% 16%,
                    80% 0%,
                    43% 62%
                );
                background-color: #3b82f6;
            }
            .custom-checkbox:checked {
                background-color: #3b82f6;
                border-color: #3b82f6;
            }
            .custom-checkbox:checked::before {
                transform: scale(1);
                background-color: white;
            }

            /* Toast Animation */
            .toast {
                animation:
                    slideUp 0.3s ease-out forwards,
                    fadeOut 0.3s ease-in 2.7s forwards;
            }
            @keyframes slideUp {
                from {
                    transform: translate(-50%, 100%);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, 0);
                    opacity: 1;
                }
            }
            @keyframes fadeOut {
                to {
                    opacity: 0;
                }
            }
        </style>
    </head>
    <body
        class="bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-100 min-h-screen font-sans pb-32"
    >
        <nav
            class="bg-blue-900 dark:bg-slate-900 text-white shadow-lg sticky top-0 z-50"
        >
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <i
                            data-lucide="candycane"
                            class="h-6 w-6 text-pink-400"
                        ></i>
                        <span class="font-bold text-xl tracking-tight"
                            >NorthScrape</span
                        >
                    </div>
                    <div class="flex items-center gap-4">
                        <button
                            id="theme-toggle"
                            class="p-2 rounded-lg bg-blue-800 dark:bg-slate-800 hover:bg-blue-700 transition-colors"
                        >
                            <i
                                data-lucide="moon"
                                id="theme-icon"
                                class="h-5 w-5 text-yellow-300"
                            ></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div
                id="drop-zone"
                class="border-4 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl p-12 text-center hover:border-blue-500 transition-colors cursor-pointer bg-white dark:bg-slate-900"
            >
                <i
                    data-lucide="upload-cloud"
                    class="h-16 w-16 mx-auto text-slate-400 mb-4"
                ></i>
                <h3 class="text-xl font-bold dark:text-white">
                    Load Leads CSV
                </h3>
                <p class="text-slate-500 mt-2">
                    Drag & Drop or Click to Upload
                </p>
                <input
                    type="file"
                    id="file-input"
                    class="hidden"
                    accept=".csv"
                />
            </div>

            <div id="dashboard" class="hidden space-y-6">
                <div
                    class="flex flex-col md:flex-row gap-4 items-center bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border dark:border-slate-800"
                >
                    <div class="relative flex-grow w-full">
                        <i
                            data-lucide="search"
                            class="absolute left-3 top-3 h-5 w-5 text-slate-400"
                        ></i>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Search name, address, phone..."
                            class="w-full pl-10 pr-4 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>

                    <div
                        class="flex gap-4 w-full md:w-auto overflow-x-auto pb-2 md:pb-0"
                    >
                        <label
                            class="flex items-center gap-2 cursor-pointer select-none whitespace-nowrap"
                        >
                            <input
                                type="checkbox"
                                id="filter-phones"
                                class="custom-checkbox"
                            />
                            <span class="text-sm font-medium">Phones Only</span>
                        </label>
                        <label
                            class="flex items-center gap-2 cursor-pointer select-none whitespace-nowrap"
                        >
                            <input
                                type="checkbox"
                                id="filter-pending"
                                class="custom-checkbox"
                            />
                            <span class="text-sm font-medium"
                                >Pending Only</span
                            >
                        </label>
                    </div>

                    <div class="flex gap-2">
                        <button
                            onclick="app.exportPDF()"
                            class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg"
                            title="Export PDF"
                        >
                            <i data-lucide="file-down" class="h-5 w-5"></i>
                        </button>
                        <button
                            onclick="app.reset()"
                            class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
                            title="Reset Data"
                        >
                            <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-blue-500"
                    >
                        <p
                            class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold"
                        >
                            Total Leads
                        </p>
                        <p class="text-2xl font-bold" id="stat-total">0</p>
                    </div>
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-green-500"
                    >
                        <p
                            class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold"
                        >
                            Has Phone
                        </p>
                        <p class="text-2xl font-bold" id="stat-phones">0</p>
                    </div>
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-purple-500"
                    >
                        <p
                            class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold"
                        >
                            Pending
                        </p>
                        <p class="text-2xl font-bold" id="stat-pending">0</p>
                    </div>
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-orange-500"
                    >
                        <p
                            class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold"
                        >
                            Route
                        </p>
                        <p class="text-2xl font-bold" id="stat-route">0</p>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-slate-900 rounded-xl shadow border dark:border-slate-800 overflow-hidden"
                >
                    <div class="overflow-x-auto">
                        <table
                            class="min-w-full divide-y divide-slate-200 dark:divide-slate-800"
                        >
                            <thead class="bg-slate-50 dark:bg-slate-950">
                                <tr>
                                    <th
                                        class="w-12 px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase"
                                    >
                                        Stat
                                    </th>
                                    <th
                                        class="w-12 px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase"
                                    >
                                        Route
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase cursor-pointer hover:text-blue-500"
                                        onclick="app.sort('Name')"
                                    >
                                        Name
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase cursor-pointer hover:text-blue-500"
                                        onclick="app.sort('Address')"
                                    >
                                        Location
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase"
                                    >
                                        Phone
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase"
                                    >
                                        Map
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                id="table-body"
                                class="divide-y divide-slate-200 dark:divide-slate-800"
                            ></tbody>
                        </table>
                    </div>
                    <div
                        class="px-6 py-4 border-t dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950"
                    >
                        <span id="page-info" class="text-sm text-slate-500"
                            >Showing 0-0 of 0</span
                        >
                        <div class="flex gap-2">
                            <button
                                onclick="app.changePage(-1)"
                                class="px-3 py-1 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded text-sm hover:bg-slate-50"
                            >
                                Prev
                            </button>
                            <button
                                onclick="app.changePage(1)"
                                class="px-3 py-1 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded text-sm hover:bg-slate-50"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <button
            onclick="app.launchRoute()"
            id="fab-route"
            class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl transform transition-transform scale-0 flex items-center gap-2 z-50"
        >
            <i data-lucide="navigation" class="w-6 h-6"></i>
            <span class="font-bold pr-2"
                >GO (<span id="fab-count">0</span>)</span
            >
        </button>

        <div
            id="toast-container"
            class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[60] pointer-events-none flex flex-col items-center gap-2"
        ></div>

        <script>
            // --- 1. CORE LOGIC ---
            const app = {
                data: [],
                filtered: [],
                contacted: JSON.parse(
                    localStorage.getItem("contacted") || "[]",
                ),
                route: new Set(),
                page: 1,
                limit: 50,
                sortCol: null,
                sortDir: "asc",

                init() {
                    // Theme
                    if (
                        localStorage.theme === "dark" ||
                        (!("theme" in localStorage) &&
                            window.matchMedia("(prefers-color-scheme: dark)")
                                .matches)
                    ) {
                        document.documentElement.classList.add("dark");
                    }

                    // Event Listeners
                    document.getElementById("theme-toggle").onclick =
                        this.toggleTheme;
                    document.getElementById("drop-zone").onclick = () =>
                        document.getElementById("file-input").click();
                    document.getElementById("file-input").onchange = (e) =>
                        this.loadFile(e.target.files[0]);

                    // Drag & Drop
                    const dz = document.getElementById("drop-zone");
                    dz.ondragover = (e) => {
                        e.preventDefault();
                        dz.classList.add("border-blue-500");
                    };
                    dz.ondragleave = () =>
                        dz.classList.remove("border-blue-500");
                    dz.ondrop = (e) => {
                        e.preventDefault();
                        dz.classList.remove("border-blue-500");
                        this.loadFile(e.dataTransfer.files[0]);
                    };

                    // Search/Filter Listeners
                    document.getElementById("search-input").oninput = () =>
                        this.applyFilters();
                    document.getElementById("filter-phones").onchange = () =>
                        this.applyFilters();
                    document.getElementById("filter-pending").onchange = () =>
                        this.applyFilters();

                    lucide.createIcons();

                    // Auto-load if file exists (dev convenience)
                    fetch("leads.csv").then((r) =>
                        r.ok ? r.text().then((t) => this.parseCSV(t)) : null,
                    );
                },

                toggleTheme() {
                    document.documentElement.classList.toggle("dark");
                    localStorage.theme =
                        document.documentElement.classList.contains("dark")
                            ? "dark"
                            : "light";
                    const icon = document.getElementById("theme-icon");
                    icon.setAttribute(
                        "data-lucide",
                        localStorage.theme === "dark" ? "sun" : "moon",
                    );
                    lucide.createIcons();
                },

                loadFile(file) {
                    if (!file) return;
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => this.parseCSV(null, res.data),
                    });
                },

                parseCSV(text, dataObj) {
                    const data =
                        dataObj ||
                        Papa.parse(text, { header: true, skipEmptyLines: true })
                            .data;
                    if (!data.length || !data[0].Name)
                        return alert("Invalid CSV: Needs 'Name' column");

                    // Generate IDs & Clean Data
                    this.data = data.map((r) => ({
                        ...r,
                        id: btoa(
                            unescape(
                                encodeURIComponent(
                                    (r.Name || "") + (r.Address || ""),
                                ),
                            ),
                        ).substring(0, 16),
                        Phone: r.Phone && r.Phone !== "N/A" ? r.Phone : null,
                    }));

                    document
                        .getElementById("drop-zone")
                        .classList.add("hidden");
                    document
                        .getElementById("dashboard")
                        .classList.remove("hidden");
                    this.applyFilters();
                },

                applyFilters() {
                    const q = document
                        .getElementById("search-input")
                        .value.toLowerCase();
                    const phonesOnly =
                        document.getElementById("filter-phones").checked;
                    const pendingOnly =
                        document.getElementById("filter-pending").checked;

                    this.filtered = this.data.filter((r) => {
                        const txt = (
                            r.Name +
                            r.Address +
                            (r.Phone || "")
                        ).toLowerCase();
                        const hasPhone = !!r.Phone;
                        const isContacted = this.contacted.includes(r.id);

                        return (
                            txt.includes(q) &&
                            (!phonesOnly || hasPhone) &&
                            (!pendingOnly || !isContacted)
                        );
                    });

                    if (this.sortCol) {
                        this.filtered.sort((a, b) => {
                            const valA = (a[this.sortCol] || "").toLowerCase();
                            const valB = (b[this.sortCol] || "").toLowerCase();
                            return (
                                (valA < valB ? -1 : 1) *
                                (this.sortDir === "asc" ? 1 : -1)
                            );
                        });
                    }

                    this.page = 1;
                    this.updateStats();
                    this.render();
                },

                render() {
                    const start = (this.page - 1) * this.limit;
                    const pageData = this.filtered.slice(
                        start,
                        start + this.limit,
                    );
                    const tbody = document.getElementById("table-body");
                    tbody.innerHTML = "";

                    pageData.forEach((r) => {
                        const isDone = this.contacted.includes(r.id);
                        const isRoute = this.route.has(r.id);
                        const tr = document.createElement("tr");
                        tr.className = `hover:bg-slate-50 dark:hover:bg-slate-800 ${isDone ? "opacity-50 grayscale" : ""}`;

                        tr.innerHTML = `
                        <td class="px-6 py-4"><input type="checkbox" class="custom-checkbox" ${isDone ? "checked" : ""} onchange="app.toggleStat('${r.id}')"></td>
                        <td class="px-6 py-4"><button onclick="app.toggleRoute('${r.id}')" class="transition ${isRoute ? "text-blue-500" : "text-slate-300"}"><i data-lucide="map-pin" class="w-5 h-5 ${isRoute ? "fill-current" : ""}"></i></button></td>
                        <td class="px-6 py-4 font-medium dark:text-white">${r.Name}</td>
                        <td class="px-6 py-4 text-slate-500 dark:text-slate-400 text-sm">${r.Address}</td>
                        <td class="px-6 py-4">${r.Phone ? `<a href="tel:${r.Phone}" class="text-green-600 font-mono font-bold hover:underline bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded">${r.Phone}</a>` : '<span class="text-slate-300 text-xs">N/A</span>'}</td>
                        <td class="px-6 py-4"><a href="https://maps.google.com/?q=${encodeURIComponent(r.Address)}" target="_blank" class="text-blue-500 hover:underline text-sm">Map</a></td>
                    `;
                        tbody.appendChild(tr);
                    });

                    // Pagination UI
                    document.getElementById("page-info").innerText =
                        `Showing ${start + 1}-${Math.min(start + this.limit, this.filtered.length)} of ${this.filtered.length}`;
                    lucide.createIcons();
                },

                updateStats() {
                    document.getElementById("stat-total").innerText =
                        this.data.length;
                    document.getElementById("stat-phones").innerText =
                        this.data.filter((r) => r.Phone).length;
                    document.getElementById("stat-pending").innerText =
                        this.data.length - this.contacted.length;
                    document.getElementById("stat-route").innerText =
                        this.route.size;
                    document.getElementById("fab-count").innerText =
                        this.route.size;

                    const fab = document.getElementById("fab-route");
                    this.route.size > 0
                        ? fab.classList.remove("scale-0")
                        : fab.classList.add("scale-0");
                },

                // Actions
                toggleStat(id) {
                    if (this.contacted.includes(id))
                        this.contacted = this.contacted.filter((i) => i !== id);
                    else this.contacted.push(id);
                    localStorage.setItem(
                        "contacted",
                        JSON.stringify(this.contacted),
                    );
                    this.applyFilters(); // Re-render to update stats/visuals
                },

                toggleRoute(id) {
                    this.route.has(id)
                        ? this.route.delete(id)
                        : this.route.add(id);
                    this.updateStats();
                    this.render(); // Re-render for icon update
                },

                changePage(dir) {
                    const max = Math.ceil(this.filtered.length / this.limit);
                    if (this.page + dir > 0 && this.page + dir <= max) {
                        this.page += dir;
                        this.render();
                        window.scrollTo({ top: 0, behavior: "smooth" });
                    }
                },

                sort(col) {
                    if (this.sortCol === col)
                        this.sortDir = this.sortDir === "asc" ? "desc" : "asc";
                    else {
                        this.sortCol = col;
                        this.sortDir = "asc";
                    }
                    this.applyFilters();
                },

                reset() {
                    if (confirm("Clear all data?")) location.reload();
                },

                launchRoute() {
                    const stops = this.data
                        .filter((r) => this.route.has(r.id))
                        .map((r) => encodeURIComponent(r.Address));
                    if (stops.length) {
                        let url = "https://www.google.com/maps/dir/?api=1";
                        if (stops.length === 1)
                            url += `&destination=${stops[0]}`;
                        else {
                            const dest = stops.pop();
                            url += `&destination=${dest}&waypoints=${stops.join("|")}`;
                        }
                        window.open(url, "_blank");
                    }
                },

                exportPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text("NorthScrape Leads", 14, 20);
                    doc.autoTable({
                        startY: 30,
                        head: [["Name", "Address", "Phone"]],
                        body: this.filtered.map((r) => [
                            r.Name,
                            r.Address,
                            r.Phone || "",
                        ]),
                    });
                    doc.save("leads.pdf");
                },
            };

            // Boot
            app.init();
        </script>
    </body>
</html>
